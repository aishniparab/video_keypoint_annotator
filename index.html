<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Pupil Annotator</title>

  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- video -->
<div style="position: relative;">
  <video id="video"></video>
  <canvas class="canvas" id="mycanvas"></canvas>

  <div id="right_inner"></div>
  <div id="right_pupil"></div>
  <div id="right_outer"></div>
  <div id="focus_box"></div>
  <div id="machine_status">Machine:</div>
  <div id="machine_eye_state"></div>
  <div id="annotator_status">Annotator:</div>
  <div id="annotator_eye_state"></div>
  <div id="blink_status">blink</div>

</div>

<!-- buttons -->
<br>
CSV: <input type="file" accept=".csv" id="csv-input" style="width: 200px"/>
<div id="vid-input-div" style="display: none;">Video: <input type="file" accept="video/*" id="vid-input" style="width:200px;"/></div>
<input value="Export Annotations" type="button" id="export" style="display: none;">
<button id="demo">Load Demo</button>
<br>
<br>

<!-- video state: frame and time info -->
<div id='frame-div' class="col-8" style="font-size:18px;">
  <span class="info-label">Frame:</span>
  <span id="frame-id">0</span>
  <span class="info-max">(max: </span>
  <span id="frame-id-max">0</span><span class="info-max">)</span>
  <span class="info-label" style="margin-left: 30px">Secs:</span>
  <span id="frame-ts">0</span>
  <span class="info-max">(max: </span>
  <span id="frame-ts-max">0</span><span class="info-max">)</span>
</div>
<div id="cmd-status-div" class="col-4" style="font-size:10px; display: None;">Command: <span id="cmd-status"> </span></div>

<!-- annotation display -->
<div>
  Your Annotations:
  <table>
    <tr>
      <td>Frame</td>
      <td>Outer</td>
      <td>Pupil</td>
      <td>Inner</td>
      <td>Eye State</td>
      <td>Flag</td>
      <td>Blink</td>
    </tr>
    <tr>
      <td id="disp_frame_num">null</td>
      <td id="disp_ro">null</td>
      <td id="disp_rp">null</td>
      <td id="disp_ri">null</td>
      <td id="eye_state">null</td>
      <td id="disp_flag">null</td>
      <td id="disp_blink">null</td>
    </tr>
  </table>
</div>
<br>
<br>
<br>
<!-- usage instructions -->
<b>Video Player Keyboard Shortcuts</b>
<div id="shortcuts" style="font-size:12px;">
  <ul id="keys-freebie">
  <li>
    <div class="key">
      <span>w</span>
    </div>
    <div class="label">invalid</div>
    <div class="key">
      <span>s</span>
    </div>
    <div class="label">outer</div>
    <div class="key">
      <span>z</span>
    </div>
    <div class="label">restart</div>
  </li>
  <li>
    <div class="key">
      <span>e</span>
    </div>
    <div class="label">closed</div>
    <div class="key">
      <span>d</span>
    </div>
    <div class="label">pupil</div>
    <div class="key">
      <span>x</span>
    </div>
    <div class="label">clear</div>
  </li>
  <li>
    <div class="key">
      <span>r</span>
    </div>
    <div class="label">open</div>
    <div class="key">
      <span>f</span>
    </div>
    <div class="label">inner</div>
    <div class="key">
      <span>c</span>
    </div>
    <div class="label">prev</div>
  </li>
    <li>
      <div class="key">
        <span style="display: none;"> </span>
      </div>
      <div class="label"> </div>
      <div class="key">
        <span style="display: none;"> </span>
      </div>
      <div class="label"> </div>
      <div class="key">
        <span>v</span>
      </div>
      <div class="label">next</div>
    </li>
  </ul>
</div>

<div class="instructions" style="font-size:18px;">
  <b>Instructions:</b>
  <ol>
    <li>Upload .csv file and corresponding .mp4 file</li>
    <li>Go through each frame carefully</li>
    <li>If a key point is incorrect, select the relevant keyboard shortcut and draw the correct one</li>
    <li>At the end of the video, export your annoations</li>
  </ol>
</div>

<!-- javascript source files -->
<script src="src/video_player.js"></script>
<script src="src/frame_drag.js"></script>
<script src="src/keypoints.js"></script>

<script src="omnizoom/dist/omnizoom.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script type="text/javascript" src="src/mousetrap.min.js"></script>
<script src="https://gmousse.github.io/dataframe-js/dist/dataframe.min.js"></script>
<script src="https://gmousse.github.io/dataframe-js/dist/dataframe.min.js"></script>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript">
  // page elements
  var vid = document.getElementById('video');
  const container = document.getElementById("omnizoom-container");
  var createObjectURL = (window.URL || window.webkitURL).createObjectURL;
  var divFrameId = document.querySelector('#frame-id');
  var divFrameTs = document.querySelector('#frame-ts');
  var divCmdStatus = document.querySelector('#cmd-status');
  var vidInput = document.querySelector('#vid-input');
  var csvInput = document.querySelector('#csv-input');
  var vid_max = document.querySelector('#frame-ts-max');
  var frame_max = document.querySelector('#frame-id-max');

  // initialize keypoint variables for df
  const right_pupil_kp = document.querySelector('#right_pupil');
  const right_inner_kp = document.querySelector('#right_inner');
  const right_outer_kp = document.querySelector('#right_outer');
  // focus box vars for display
  const focus_box_el = document.querySelector('#focus_box');
  const machine_status_el = document.querySelector('#machine_status');
  const machine_eye_state_el = document.querySelector('#machine_eye_state');
  const annotator_status_el = document.querySelector('#annotator_status');
  const annotator_eye_state_el = document.querySelector('#annotator_eye_state');
  const blink_status_el = document.querySelector('#blink_status');

  //const aspect_ratio = parseFloat(1920)/parseFloat(1080);
  var fps = 30;
  var smallDelta = 0.001;
  var playbackSpeed = 1;

  // set up df
  var DataFrame = dfjs.DataFrame; // input csv
  var annotations = new DataFrame([],['frame_num', 'pupil_x', 'pupil_y', 'inner_x', 'inner_y', 'outer_x', 'outer_y', 'eye_state', 'is_bad']);

  // key point vars for display
  var kp_selection = null;
  var click_count = 0;
  var current_click_pos = null;
  var kp_inner_selection_count = null;
  var kp_outer_selection_count = null;
  var kp_pupil_selection_count = null;
  var kp_prev_inner_pos = null;
  var kp_prev_outer_pos = null;
  var kp_prev_pupil_pos = null;

  // display annotation vars
  var disp_frame_num = document.querySelector('#disp_frame_num');
  var disp_ri = document.querySelector('#disp_ri');
  var disp_rp = document.querySelector('#disp_rp');
  var disp_ro = document.querySelector('#disp_ro');
  var disp_flag = document.querySelector('#disp_flag');
  var disp_blink = document.querySelector('#disp_blink');
  var disp_flag_status = 0;
  var eye_state = document.querySelector('#eye_state');
  var blink_flag = null;

  // set key bindings
  Mousetrap.bind('c', function (e) {
    // prev frame
    take_step(-1);
  }, 'keydown');
  Mousetrap.bind('v', function (e) {
    // next frame
    take_step(1);

  }, 'keydown');
  Mousetrap.bind('z', function (e) {
    // restart video
    e.preventDefault();
    jump(0);
  });
  Mousetrap.bind('w', function (e) {
    //flag annotation as bad
     // update table display
    if (disp_flag_status == 1){
      disp_flag_status = 0;
      disp_flag.innerHTML = "null";
      annotations = annotations.setRow(current_frame(), row => row.set("is_bad", 1));
    }
    else if (disp_flag_status == 0){
      disp_flag_status = 1;
      disp_flag.innerHTML = "1";
      annotations = annotations.setRow(current_frame(), row => row.set("is_bad", "null"));
    }
    annotations.show();
  });
  Mousetrap.bind('s', function (e){
    // select outer corner
    kp_selection = 'outer';
    click_count = 0;
  });
  Mousetrap.bind('d', function (e){
    // select pupil
    kp_selection = 'pupil';
    click_count = 0;
  });
  Mousetrap.bind('f', function (e){
    // select inner corner
    kp_selection = 'inner';
    click_count = 0;
  });
  Mousetrap.bind('e', function (e){
    // set eye state to closed
    annotations = annotations.setRow(current_frame(), row => row.set("eye_state", 0));

    annotator_eye_state_el.innerHTML = "closed";
    eye_state.innerHTML = "closed";
    document.getElementById("annotator_eye_state").style.color = "#C0FF96";
  });
  Mousetrap.bind('r', function (e){
    // set eye state to open
    annotations = annotations.setRow(current_frame(), row => row.set("eye_state", 1));
    eye_state.innerHTML = "open";
    annotator_eye_state_el.innerHTML = "open";
    document.getElementById("annotator_eye_state").style.color = "#2FA5FF";
  });
  Mousetrap.bind('x', function(e) {
    // clear all annotations from display
    clear_all_points();
    // clear all annotations from df
    annotations = annotations.setRow(current_frame(), row => row.set("pupil_x", null));
    annotations = annotations.setRow(current_frame(), row => row.set("pupil_y", null));
    annotations = annotations.setRow(current_frame(), row => row.set("inner_x", null));
    annotations = annotations.setRow(current_frame(), row => row.set("inner_y", null));
    annotations = annotations.setRow(current_frame(), row => row.set("outer_x", null));
    annotations = annotations.setRow(current_frame(), row => row.set("outer_y", null));
    annotations = annotations.setRow(current_frame(), row => row.set("eye_state", null));
    annotations = annotations.setRow(current_frame(), row => row.set("is_bad", null));
    annotations = annotations.setRow(current_frame(), row => row.set("blink", null));
    // update display
    disp_frame_num.innerHTML = current_frame();
    disp_ro.innerHTML = "null, null";
    disp_rp.innerHTML = "null, null";
    disp_ri.innerHTML = "null, null";
    annotator_eye_state_el.innerHTML = "null";
    disp_flag.innerHTML = "null";
  });
  Mousetrap.bind('shift+up', function(e){
    //sub delta to kp_y
    var current_x = current_click_pos[0];
    var current_y = current_click_pos[1];
    var new_y = current_y - 1;
    current_click_pos = [current_x, new_y]
    clear_point(current_x, current_y);
    draw_point(current_x, new_y);
    if (kp_selection == 'outer'){
      kp_prev_outer_pos = current_click_pos;
    }
    if (kp_selection == 'pupil'){
      kp_prev_pupil_pos = current_click_pos;
    }
    if (kp_selection == 'inner'){
      kp_prev_inner_pos = current_click_pos;
    }
  });
  Mousetrap.bind('shift+down', function(e){
    //add delta to kp_y
    var current_x = current_click_pos[0];
    var current_y = current_click_pos[1];
    var new_y = current_y + 1;
    current_click_pos = [current_x, new_y]
    clear_point(current_x, current_y);
    draw_point(current_x, new_y);
    if (kp_selection == 'outer'){
      kp_prev_outer_pos = current_click_pos;
    }
    if (kp_selection == 'pupil'){
      kp_prev_pupil_pos = current_click_pos;
    }
    if (kp_selection == 'inner'){
      kp_prev_inner_pos = current_click_pos;
    }
  });
  Mousetrap.bind('shift+left', function(e){
    //sub delta to kp_x
    var current_x = current_click_pos[0];
    var current_y = current_click_pos[1];
    var new_x = current_x - 1;
    current_click_pos = [new_x, current_y]
    clear_point(current_x, current_y);
    draw_point(new_x, current_y);
    if (kp_selection == 'outer'){
      kp_prev_outer_pos = current_click_pos;
    }
    if (kp_selection == 'pupil'){
      kp_prev_pupil_pos = current_click_pos;
    }
    if (kp_selection == 'inner'){
      kp_prev_inner_pos = current_click_pos;
    }
  });
  Mousetrap.bind('shift+right', function(e){
    //add delta to kp_x
    var current_x = current_click_pos[0];
    var current_y = current_click_pos[1];
    var new_x = current_x + 1;
    current_click_pos = [new_x, current_y]
    clear_point(current_x, current_y);
    draw_point(new_x, current_y);
    if (kp_selection == 'outer'){
      kp_prev_outer_pos = current_click_pos;
    }
    if (kp_selection == 'pupil'){
      kp_prev_pupil_pos = current_click_pos;
    }
    if (kp_selection == 'inner'){
      kp_prev_inner_pos = current_click_pos;
    }
  });
  Mousetrap.bind('b', function(e) {

    if (blink_flag == 1){
      blink_flag = 0;
      blink_status_el.style.visibility = "hidden";
      disp_blink.innerHTML = "null";
      annotations = annotations.setRow(current_frame(), row => row.set("blink", "null"));
    }
    else{
      blink_flag = 1;
      blink_status_el.style.visibility = "visible";
      disp_blink.innerHTML = "1";
      annotations = annotations.setRow(current_frame(), row => row.set("blink", 1));
    }
    annotations.show();
  });


  vid.ontimeupdate = function () {
    //update_current_state();
    var cf = current_frame();
    clear_all_points();
    if (cf >= 0) {
      display_model_predictions(cf);
      display_annotations(cf);
    }
  };

  csvInput.addEventListener('change', load_csv, false);
  vidInput.addEventListener('change', play_selected_file, false);

  // order of events once video is loaded
  vid.onloadeddata = function () {
    // assert # frames in csv and video match
    var df_count = DataFrame.sql.request(`SELECT COUNT(*) FROM tmp`);
    console.assert(df_count/2 == frame_count());

    // initialize
    const frame_num_array = [...Array(frame_count()).keys()];
    const null_array = new Array(frame_count()).fill(null);
    annotations = new DataFrame({
      frame_num: frame_num_array,
      pupil_x: null_array,
      pupil_y: null_array,
      inner_x: null_array,
      inner_y: null_array,
      outer_x: null_array,
      outer_y: null_array,
      eye_state: null_array,
      is_bad: null_array,
      blink: null_array,
    },['frame_num', 'pupil_x', 'pupil_y', 'inner_x', 'inner_y', 'outer_x', 'outer_y', 'eye_state', 'is_bad', 'blink']);

    jump(0);
    update_current_state();
    resize_canvas(vid);
    frame_max.innerHTML = frame_count()-1;
    vid_max.innerHTML = vid.duration;
    document.getElementById("export").style.display = "inline";
  }

  // draw key point
  $("#mycanvas").click(function(e){
    var click_pos = get_click_position(e);
    current_click_pos = click_pos;
    var click_pos_x = click_pos[0];
    var click_pos_y = click_pos[1];

    if (kp_selection == "outer"){
      if (click_count == 0){
        click_count = 1;
        if (kp_outer_selection_count == 1) {
          clear_point(kp_prev_outer_pos[0], kp_prev_outer_pos[1]);
          kp_outer_selection_count = 0
        }
        kp_selection = "outer";
        kp_outer_selection_count = 1;
        kp_prev_outer_pos = [click_pos_x, click_pos_y];
        draw_point(click_pos_x, click_pos_y, "#2FA5FF");
        annotations = annotations.setRow(current_frame(), row => row.set("outer_x", click_pos_x));
        annotations = annotations.setRow(current_frame(), row => row.set("outer_y", click_pos_y));
        disp_ro.innerHTML = `${click_pos_x}, ${click_pos_y}`; // update table display
      }
    }
    if (kp_selection == "pupil"){
      if (click_count == 0){
        click_count = 1;
        if (kp_pupil_selection_count == 1){
          clear_point(kp_prev_pupil_pos[0], kp_prev_pupil_pos[1]);
          kp_pupil_selection_count = 0;
        }
        kp_selection = "pupil";
        kp_pupil_selection_count = 1;
        kp_prev_pupil_pos = [click_pos_x, click_pos_y];
        draw_point(click_pos_x, click_pos_y, "#FF3521");
        annotations = annotations.setRow(current_frame(), row => row.set("pupil_x", click_pos_x));
        annotations = annotations.setRow(current_frame(), row => row.set("pupil_y", click_pos_y));
        disp_rp.innerHTML = `${click_pos_x}, ${click_pos_y}`; // update table display
      }
    }
    if (kp_selection == "inner"){
      if (click_count == 0){
        click_count = 1;
        if (kp_inner_selection_count == 1){
          clear_point(kp_prev_inner_pos[0], kp_prev_inner_pos[1]);
          kp_inner_selection_count = 0;
        }
        kp_selection = "inner";
        kp_inner_selection_count = 1;
        kp_prev_inner_pos = [click_pos_x, click_pos_y];
        draw_point(click_pos_x, click_pos_y, "#C0FF96");
        annotations = annotations.setRow(current_frame(), row => row.set("inner_x", click_pos_x));
        annotations = annotations.setRow(current_frame(), row => row.set("inner_y", click_pos_y));
        disp_ri.innerHTML = `${click_pos_x}, ${click_pos_y}`; // update table display
      }
    }
  });

  // export annotations
  $("#export").click(function(e){
    var data = annotations.toCSV(true);
    export_csv("annotations.csv",data);
  });

  $("#demo").click(function(e){
    vid.src = '/videos/aishni_sample.mp4';

    DataFrame.fromCSV('/videos/aishni_sample.csv').then(df => {
      var ret = DataFrame.sql.registerTable(df, 'tmp', true);
    });
  });

</script>

</body>
</html>